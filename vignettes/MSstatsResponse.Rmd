---
title: "MSstatsResponse : A package for detecting drug-protein interactions in dose response mass spectrometry-based proteomics experiments"
author: "Sarah Szvetecz (<szvetecz.s@northeastern.edu>)"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MSstatsResponse User Guide}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## 0. Load MSstatsResponse

Load MSstatsResponse

```{r}
# ## Install MSstatsResponse package from Bioconductor
# if (!requireNamespace("BiocManager", quietly = TRUE))
#   install.packages("BiocManager")
# 
# BiocManager::install("MSstatsResponse")

library(MSstatsResponse)
library(dplyr)
library(MSstats)
library(MSstatsTMT)
library(tidyverse)
```

This vignette summarizes the introduction and various options of all functionalities in MSstatsResponse.

MSstatsResponse is a flexible tool that works with proteomics dose response data.
This package is designed to take protein summarized data, with varying treated conditions, as input.
Default is set to work in the MSstats framework, but this tool is flexible to work with other doses response datasets as well.

-   A set of tools for detecting drug-protein interactions mass spectrometry-based proteomic experiments and estimating response at which 50% inhibition is reached (i.e. IC50).
-   Supports all experiments that can be analyzed using the MSstats and MSstatsTMT R package. Can be applied to other dose response experiments as well.

MSstatsResponse includes the following three steps for statistical testing:

1.  Converter to prepare data to be in input with required format: `MSstatsPrepareDoseResponseFit`.
2.  Drug-protein interaction detection based using protein quantification data: `DoseResponseFit`
3.  IC50 prediction and confidence estimation: `PredictIC50`

## 1. Use base MSstats to perform data cleaning, normalization, and protein summarization  

### MSstatsPrepareDoseResponseFit( )

Convert experimental data into the required input format for MSstatsResponse.

#### Arguments

-   `data` : data.frame of dose response dataset (e.g. data\$ProteinLevelData from MSstats)
-   `dose_column` : name of column in `data` containing dose values (e.g., "dose", "drug_concentration", "treatment")
-   `protein_column` : name of column in `data` containing protein identifiers (e.g., "Protein")
-   `log_abundance_column` : name of column in `data` containing log-transformed abundance values (e.g., "LogIntensities")

#### Example

First, pre-process data using base MSstats:

```{r}
# Read in raw data 
#msstats_report = read_tsv("../data/DIAdata_MSstats_Report.tsv")
#head(msstats_report)

# Pre-process data using MSstats 
#quant_dia = SpectronauttoMSstatsFormat(msstats_report)
#quant_dia_summarized = dataProcess(quant_dia,
#                                   normalization = FALSE,
#                                   MBimpute = FALSE,
#                                   maxQuantileforCensored = 1)

#head(quant_dia_summarized)


# Data load / subset 
#dia_norm_temp = readRDS("../../Chemoproteomics/Chemoproteomics_Pfizer/Pfizer/data/processed_data_MSstats/dia_median_norm.RDS")
#dia_norm_temp$ProteinLevelData = dia_norm_temp$ProteinLevelData %>%
 # filter(Protein %in% c("P00519","P12931","Q9P2K8"))
#dia_norm_temp$FeatureLevelData = dia_norm_temp$FeatureLevelData %>%
#  filter(PROTEIN %in% c("P00519","P12931","Q9P2K8"))
#saveRDS(dia_norm_temp, "../data/DIA_MSstats_Normalized.RDS")

# Read in pre-proccessed data example -- 
dia_normalized = readRDS("../data/DIA_MSstats_Normalized.RDS")
dia_normalized$ProteinLevelData[1:5,]
```

```{r}
# Step 1: Format numerical dose column: 
dia_normalized$ProteinLevelData = dia_normalized$ProteinLevelData %>%
  mutate(dose = ConvertGroupToNumericDose(GROUP)$dose_nM, 
         drug = ConvertGroupToNumericDose(GROUP)$drug)

# Convert to MSstatsResponse data format via MSstatsPrepareDoseResponseFit()
dia_pl = MSstatsPrepareDoseResponseFit(dia_normalized$ProteinLevelData)
dia_pl[1:27,]

```


Here is the summary of pre-processing steps in `MSstatsPrepareDoseResponseFit` function.

add


## 2. Drug-Protein Interaction Detection

### DoseResponseFit( )

After reading the input files and get the data with required format, `MSstatsResponse` performs

-   Fitted Isotonic Regression model using desired montonicity constraint. Defualt is 'non-increasing'.

-   F-test comparing fitted model to average response 

-   Multiple testing correction using BH


#### Arguments

* `data` : protein level formatted with MSstatsPrepareDoseResponseFit() function
* `weights` : Optional numeric vector of weights. Defaults to equal weights.
* `increasing` : Logical. If TRUE, fits a non-decreasing model. If FALSE, fits non-increasing.
* `transform_dose` : Logical. If TRUE, applies log10(dose + 1) transformation. Default is TRUE.
* `ratio_response` : Logical. If TRUE, converts log abundance to ratios (i.e. relative response to DMSO). Default is FALSE.



#### Example

```{r, message=F, warning=F, results='hide'}
# use MSstatsResponse for drug-response drug-interaction 

response_results = DoseResponseFit(dia_pl,
                                   increasing = FALSE)

response_results[1:3,]
```


## 3. PredictIC50( )
Predict IC50 (dose where response is 0.5) for all proteins in dataset.  Compute 95% confidence intervals (parameter estimation with bootstrapping) 

### Arguments

* `data` : protein level formatted with MSstatsPrepareDoseResponseFit() function
* `increasing` : Logical. If TRUE, fits a non-decreasing model. If FALSE, fits non-increasing.

### Example

```{r, message=F, warning=F, results='hide'}
# test for all the possible pairs of conditions
ic50_predictions = PredictIC50(dia_pl,ratio_response = FALSE)
ic50_predictions[1:3,]
```


## Visualization 
```{r}
 
VisualizeResponseProtein(
  data = dia_pl,
  protein_name = "P12931",
  drug_name = "Dasatinib",
  ratio_response = FALSE,
  show_ic50 = TRUE,
  x_lab = "dose (nM)",
  y_lab = "Relative Response"
)

VisualizeResponseProtein(
  data = dia_pl,
  protein_name = "P00519",
  drug_name = "Dasatinib",
  ratio_response = TRUE,
  show_ic50 = TRUE,
  x_lab = "dose (nM)",
  y_lab = "Relative Response"
)
```
