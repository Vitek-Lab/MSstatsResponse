---
title: "MSstatsResponse : A package for detecting drug-protein interactions in dose response mass spectrometry-based proteomics experiments"
author: "Sarah Szvetecz (<szvetecz.s@northeastern.edu>)"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MSstatsResponse User Guide}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

This vignette introduces the MSstatsResponse package, which provides tools for detecting drug–protein interactions and estimating IC50 values from dose-response mass spectrometry-based proteomics experiments.

MSstatsResponse is designed to work with summarized data from the MSstats and MSstatsTMT workflows, but it can also be used with other dose-response datasets that include protein-level quantifications across drug treatments.

MSstatsResponse includes the following three steps for statistical analysis:

1. Convert input data to the required format using: `MSstatsPrepareDoseResponseFit()`
2. Detect drug–protein interactions using isotonic regression and F-tests: `DoseResponseFit()`
3. Estimate IC50 values and confidence intervals: `PredictIC50()`

---

## 0. Load MSstatsResponse

Load MSstatsResponse

```{r}
# ## Install MSstatsResponse package from Bioconductor
# if (!requireNamespace("BiocManager", quietly = TRUE))
#   install.packages("BiocManager")
# 
# BiocManager::install("MSstatsResponse")

library(MSstatsResponse)
library(dplyr)
library(MSstats)
library(MSstatsTMT)
library(tidyverse)
```


## 1. Use base MSstats to perform data cleaning, normalization, and protein summarization  

#### Example

First, pre-process data using base MSstats:

```{r}
# Read in raw data 
#msstats_report = read_tsv("../data/DIAdata_MSstats_Report.tsv")
#head(msstats_report)

# Pre-process data using MSstats 
#quant_dia = SpectronauttoMSstatsFormat(msstats_report)
#quant_dia_summarized = dataProcess(quant_dia,
#                                   normalization = FALSE,
#                                   MBimpute = FALSE,
#                                   maxQuantileforCensored = 1)

#head(quant_dia_summarized)


# Data load / subset 
#dia_norm_temp = readRDS("../../Chemoproteomics/Chemoproteomics_Pfizer/Pfizer/data/processed_data_MSstats/dia_median_norm.RDS")
#dia_norm_temp$ProteinLevelData = dia_norm_temp$ProteinLevelData %>%
 # filter(Protein %in% c("P00519","P12931","Q9P2K8"))
#dia_norm_temp$FeatureLevelData = dia_norm_temp$FeatureLevelData %>%
#  filter(PROTEIN %in% c("P00519","P12931","Q9P2K8"))
#saveRDS(dia_norm_temp, "../data/DIA_MSstats_Normalized.RDS")

# Read in pre-proccessed data example -- 
dia_normalized = readRDS("../inst/extdata/DIA_MSstats_Normalized.RDS")
dia_normalized$ProteinLevelData[1:5,]
```


### `ConvertGroupToNumericDose()`

This optional function converts MSstats-style `GROUP` labels into numeric dose values (in nanomolar, nM) and extracts the associated drug names. It is typically used before formatting the dataset with `MSstatsPrepareDoseResponseFit()`.

It supports inputs like `"Dasatinib_003uM"` or `"Capmatinib_300nM"` and assigns a dose of 0 to `"DMSO"`.

**Assumptions:**

- `"DMSO"` is treated as the control group and assigned a dose of **0**
- Doses must end with either `"uM"` (converted to nM by multiplying by 1000) or `"nM"`

#### Output

A data frame with two columns:
- `drug`: The drug name as a character string
- `dose_nM`: The numeric dose in nanomolar (nM)


```{r}
# Step 1: Format numerical dose column: 
dia_normalized$ProteinLevelData = dia_normalized$ProteinLevelData %>%
  mutate(dose = ConvertGroupToNumericDose(GROUP)$dose_nM, 
         drug = ConvertGroupToNumericDose(GROUP)$drug)
```


### MSstatsPrepareDoseResponseFit( )

This function prepares the dataset for dose-response analysis by standardizing column names and structure. It expects summarized protein-level intensities across drug conditions.

#### Arguments

- `data`: A `data.frame` of summarized dose-response data (e.g., `data$ProteinLevelData` from MSstats)
- `dose_column`: Column name containing numeric dose values (e.g., `"dose"`, `"drug_concentration"`)
- `protein_column`: Column name containing protein identifiers (e.g., `"Protein"`)
- `log_abundance_column`: Column name with log-transformed abundance values (e.g., `"LogIntensities"`)

```{r}
# Convert to MSstatsResponse data format via MSstatsPrepareDoseResponseFit()
dia_pl = MSstatsPrepareDoseResponseFit(dia_normalized$ProteinLevelData)
dia_pl[1:27,]

```



## 2. Drug-Protein Interaction Detection

### `DoseResponseFit()`

After preparing the input data using `MSstatsPrepareDoseResponseFit()`, `MSstatsResponse` fits isotonic regression models to detect dose-dependent drug–protein interactions.

The function performs the following steps:

- Fits an isotonic regression model for each protein–drug pair using the specified monotonicity constraint (default: non-increasing)
- Performs an F-test to compare the fitted model against a constant (null) model
- Adjusts p-values for multiple testing using the Benjamini–Hochberg (BH) procedure

#### Arguments

- `data`: Protein-level data formatted using `MSstatsPrepareDoseResponseFit()`
- `weights`: Optional numeric vector of weights. Defaults to equal weights.
- `increasing`: Logical. If `TRUE`, fits a non-decreasing model. If `FALSE`, fits a non-increasing model.
- `transform_dose`: Logical. If `TRUE`, applies a `log10(dose + 1)` transformation. Default is `TRUE`.
- `ratio_response`: Logical. If `TRUE`, converts log2 abundance values to ratios relative to DMSO. Default is `FALSE`.

**Note:** We strongly recommend performing interaction testing on the **log2 scale** (i.e., with `ratio_response = FALSE`) for best performance. This scale stabilizes variance across doses, reduces skewness in abundance distributions, and improves the sensitivity and specificity of F-tests for detecting monotonic trends.


```{r, message=F, warning=F, results='hide'}
# use MSstatsResponse for drug-response drug-interaction 

response_results = DoseResponseFit(dia_pl,
                                   increasing = FALSE)

response_results[1:3,]
```

## 3. IC50 Estimation

### `PredictIC50()`

This function estimates the IC50 (the dose at which response is reduced to 50%) for each protein–drug pair in the dataset. Optionally, it computes 95% confidence intervals using nonparametric bootstrap resampling.

By default, IC50 is estimated on the **ratio scale** (i.e., using abundance values normalized to the DMSO control), which improves interpretability and consistency with pharmacological definitions of IC50.

Bootstrapped confidence intervals are derived from the empirical distribution of IC50 estimates across resampled datasets.

#### Arguments

- `data`: Protein-level data formatted using `MSstatsPrepareDoseResponseFit()`
- `increasing`: Logical. If `TRUE`, fits a non-decreasing model. If `FALSE`, fits a non-increasing model.
- `ratio_response`: Logical. If `TRUE`, estimates IC50 on the ratio scale (recommended). If `FALSE`, uses the log2 scale.
- `transform_dose`: Logical. If `TRUE`, applies a `log10(dose + 1)` transformation. Default is `TRUE`.
- `bootstrap`: Logical. If `TRUE`, performs bootstrap resampling to estimate 95% confidence intervals. If `FALSE`, returns point estimates only.
- `n_samples`: Number of bootstrap resamples. Default is `1000`.
- `alpha`: Confidence level for interval estimation. Default is `0.10` (for 90% intervals).

**Note:** Although IC50 estimation can be performed on either the log2 or ratio scale, we recommend using the **ratio scale** (`ratio_response = TRUE`) for more interpretable and stable confidence intervals. See Supplemental Section 2.5 for additional discussion of scale choice.


```{r, message=F, warning=F, results='hide'}
# test for all the possible pairs of conditions
ic50_predictions = PredictIC50(dia_pl,
                               ratio_response = TRUE)
ic50_predictions[1:3,]
```

## 4. Visualization

### `VisualizeResponseProtein()`

This function generates a plot of the isotonic regression fit for a selected protein–drug pair. The plot optionally includes the estimated IC50 and its confidence interval.

It is useful for visual inspection of fitted dose–response trends, confirmation of monotonicity, and visualization of IC50 estimates.

#### Arguments

- `data`: Protein-level data formatted using `MSstatsPrepareDoseResponseFit()`
- `protein_name`: Character string specifying the protein to plot
- `drug_name`: Character string specifying the drug to plot
- `increasing`: Logical. If `TRUE`, fits a non-decreasing model. If `FALSE`, fits a non-increasing model
- `ratio_response`: Logical. If `TRUE`, plots the model on the ratio scale; if `FALSE`, on the log2 scale
- `transform_dose`: Logical. If `TRUE`, applies a `log10(dose + 1)` transformation. Default is `TRUE`
- `show_ic50`: Logical. If `TRUE`, adds a vertical line and label at the IC50 estimate
- `add_ci`: Logical. If `TRUE`, adds 95% confidence interval bounds for IC50 using bootstrap
- `n_samples`: Number of bootstrap samples for confidence intervals. Default is `1000`
- `alpha`: Confidence level for interval estimation. Default is `0.10` (for 90% intervals)


```{r}
 
VisualizeResponseProtein(
  data = dia_pl,
  protein_name = "P12931",
  drug_name = "Dasatinib",
  ratio_response = FALSE,
  show_ic50 = TRUE,
  x_lab = "dose (nM)",
  y_lab = "Relative Response"
)

VisualizeResponseProtein(
  data = dia_pl,
  protein_name = "P00519",
  drug_name = "Dasatinib",
  ratio_response = TRUE,
  show_ic50 = TRUE,
  x_lab = "dose (nM)",
  y_lab = "Relative Response"
)
```
